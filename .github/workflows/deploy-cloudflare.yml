name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch: # 수동 실행 허용
    inputs:
      environment:
        description: '배포할 환경 선택'
        required: true
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 배포 환경 결정
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 수동 실행 시 사용자가 선택한 환경 사용
            DEPLOY_ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            # main 브랜치 → production
            DEPLOY_ENV="production"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            # develop 브랜치 → staging
            DEPLOY_ENV="staging"
          else
            echo "알 수 없는 브랜치입니다. 배포를 중단합니다."
            exit 1
          fi
          echo "DEPLOY_ENV=$DEPLOY_ENV" >> $GITHUB_ENV
          echo "배포 환경: $DEPLOY_ENV"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build project
        run: bun run build
        env:
          CLOUDFLARE_ENV: ${{ env.DEPLOY_ENV }}

      - name: Remove _redirects file (Cloudflare Workers doesn't need it)
        # React Router 7이 빌드 시 _redirects 파일을 생성할 수 있습니다
        # Cloudflare Workers는 SSR을 사용하므로 _redirects 파일이 필요 없고 무한 루프를 일으킬 수 있습니다
        run: |
          # build 디렉토리와 public 디렉토리에서 _redirects 파일 찾아서 삭제
          find build public -name "_redirects" -type f 2>/dev/null | while read file; do
            echo "Removing $file"
            rm -f "$file"
          done || true
          echo "✓ Checked for _redirects files (removed if found)"

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ env.DEPLOY_ENV }}
          # 참고: Cloudflare Workers의 환경 변수는 다음 방법 중 하나로 설정해야 합니다:
          # 1. Cloudflare Dashboard → Workers & Pages → [worker-name] → Settings → Variables
          # 2. 로컬에서 wrangler secret put 명령 실행 (수동)
          #
          # 각 환경(staging, production)별로 별도의 환경 변수를 설정해야 합니다:
          # - production 환경: claude-rr7-starterkit-production
          # - staging 환경: claude-rr7-starterkit-staging
          #
          # 필수 환경 변수 (3개):
          # - DATABASE_URL              # PostgreSQL 연결 문자열 (Supabase 또는 다른 PostgreSQL)
          # - BASE_URL                  # 애플리케이션 기본 URL (OAuth 콜백용)
          # - BETTER_AUTH_SECRET        # Better Auth 암호화/서명 키 (최소 32자)
          #
          # OAuth 프로바이더 환경 변수 (선택, 사용하는 프로바이더만 설정):
          # - GITHUB_CLIENT_ID
          # - GITHUB_CLIENT_SECRET
          # - GOOGLE_CLIENT_ID
          # - GOOGLE_CLIENT_SECRET
          # - KAKAO_CLIENT_ID
          # - KAKAO_CLIENT_SECRET
          #
          # 참고: VITE_* 변수는 빌드 시점에 번들에 포함되므로 Cloudflare Dashboard에 설정할 필요 없습니다

